# SOME DESCRIPTIVE TITLE.
# Copyright (C) 2021, test
# This file is distributed under the same license as the qubes-docs package.
# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
#
#, fuzzy
msgid ""
msgstr ""
"Project-Id-Version: qubes-docs \n"
"Report-Msgid-Bugs-To: \n"
"POT-Creation-Date: 2021-12-15 21:10+0100\n"
"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
"Language-Team: LANGUAGE <LL@li.org>\n"
"MIME-Version: 1.0\n"
"Content-Type: text/plain; charset=UTF-8\n"
"Content-Transfer-Encoding: 8bit\n"

#: ../developer/system/gui.md:14
#: f7c108055f464a76a4c0bc18fbe05207
msgid "qubes_gui and qubes_guid processes"
msgstr ""

#: ../developer/system/gui.md:17
#: a0de307824924e0eaefbda508eef4316
msgid "All AppVM X applications connect to local (running in AppVM) Xorg servers that use the following \"hardware\" drivers:"
msgstr ""

#: ../developer/system/gui.md:19
#: e47005dc06e0487689e6ed171c87b21d
msgid "*dummyqsb_drv* - video driver, that paints onto a framebuffer located in RAM, not connected to real hardware"
msgstr ""

#: ../developer/system/gui.md:20
#: 260f104df3b24055a4b13edb2d7006ee
msgid "*qubes_drv* - it provides a virtual keyboard and mouse (in fact, more, see below)"
msgstr ""

#: ../developer/system/gui.md:22
#: 173b2433026d431da7c2480c1b36fec6
msgid "For each AppVM, there is a pair of *qubes_gui* (running in AppVM) and *qubes_guid* (running in dom0) processes connected over vchan. The main responsibilities of *qubes_gui* are:"
msgstr ""

#: ../developer/system/gui.md:25
#: 7cd322736fe04489b59752a728293757
msgid "call XCompositeRedirectSubwindows on the root window, so that each window has its own composition buffer"
msgstr ""

#: ../developer/system/gui.md:26
#: 22c4e5cc947245239ed5df23ba35d01d
msgid "instruct the local Xorg server to notify it about window creation, configuration and damage events; pass information on these events to dom0"
msgstr ""

#: ../developer/system/gui.md:27
#: 9ffe10caa7634738923155d6eccad225
msgid "receive information about keyboard and mouse events from dom0, tell *qubes_drv* to fake appropriate events"
msgstr ""

#: ../developer/system/gui.md:28
#: ../developer/system/gui.md:35
#: 44f57db21bb040c7ac92214e44041472
#: 9bdc28af4e9a4f14a000f2600f60efb9
msgid "receive information about window size/position change, apply them to the local window"
msgstr ""

#: ../developer/system/gui.md:30
#: ec0e31ee3c714c05af276625c688e83a
msgid "The main responsibilities of *qubes_guid* are:"
msgstr ""

#: ../developer/system/gui.md:32
#: f88ca8af22d44551a5278858ba5f5679
msgid "create a window in dom0 whenever an information on window creation in AppVM is received from *qubes_gui*"
msgstr ""

#: ../developer/system/gui.md:33
#: 80868b3c931640339be26b976f7486fd
msgid "whenever the local window receives XEvent, pass information on it to AppVM (particularly, mouse and keyboard data)"
msgstr ""

#: ../developer/system/gui.md:34
#: 1f6bd9923a4646138ad97bf481fd65f2
msgid "whenever AppVM signals damage event, tell local Xorg server to repaint a given window fragment"
msgstr ""

#: ../developer/system/gui.md:37
#: df686457bf634203a0732a949822e092
msgid "Note that keyboard and mouse events are passed to AppVM only if a window belonging to this AppVM has focus. AppVM has no way to get information on keystrokes fed to other AppVMs (e.g. XTEST extension will report the status of local AppVM keyboard only) or synthesize and pass events to other AppVMs."
msgstr ""

#: ../developer/system/gui.md:40
#: 08705065595c44c1925c1d384327d2ad
msgid "Window content updates implementation"
msgstr ""

#: ../developer/system/gui.md:43
#: 08a9a42377194a88b3b24b184b62d375
msgid "Typical remote desktop applications, like *vnc*, pass information on all changed window content in-band (say, over tcp). As that channel has limited throughput, this impacts video performance. In the case of Qubes, *qubes_gui* does not transfer all changed pixels via vchan. Instead, for each window, upon its creation or size change, *qubes_gui*"
msgstr ""

#: ../developer/system/gui.md:47
#: 52e2bd91b1ca42a9ad0ae143274485ee
msgid "asks *qubes_drv* driver for the list of physical memory frames that hold the composition buffer of a window"
msgstr ""

#: ../developer/system/gui.md:48
#: 855b4511646e4cd39270c16353743c8d
msgid "passes this information via `MFNDUMP` message to *qubes_guid* in dom0"
msgstr ""

#: ../developer/system/gui.md:50
#: 994287c7518f48e6b3d903c7832caaa5
msgid "Now, *qubes_guid* has to tell the dom0 Xorg server about the location of the buffer. There is no supported way (e.g. Xorg extension) to do this zero-copy style. The following method is used in Qubes:"
msgstr ""

#: ../developer/system/gui.md:54
#: dd87d500c663480c89975c063fbf8d1b
msgid "in dom0, the Xorg server is started with *LD_PRELOAD*-ed library named *shmoverride.so*. This library hooks all function calls related to shared memory."
msgstr ""

#: ../developer/system/gui.md:55
#: ee425262e5a541cbaa1718cb68a25dbd
msgid "*qubes_guid* creates a shared memory segment, and then tells Xorg to attach it via *MIT-SHM* extension"
msgstr ""

#: ../developer/system/gui.md:56
#: cadd0f92d31e42f6af3ddcd60350763e
msgid "when Xorg tries to attach the segment (via glibc *shmat*) *shmoverride.so* intercepts this call and instead maps AppVM memory via *xc_map_foreign_pages*"
msgstr ""

#: ../developer/system/gui.md:57
#: 44355871c445440c885de98743da929b
msgid "since then, we can use MIT-SHM functions, e.g. *XShmPutImage* to draw onto a dom0 window. *XShmPutImage* will paint with DRAM speed; actually, many drivers use DMA for this."
msgstr ""

#: ../developer/system/gui.md:59
#: 17a339524adb44469cc4626402fee05a
msgid "The important detail is that *xc_map_foreign_pages* verifies that a given mfn range actually belongs to a given domain id (and the latter is provided by trusted *qubes_guid*). Therefore, rogue AppVM cannot gain anything by passing crafted mnfs in the `MFNDUMP` message."
msgstr ""

#: ../developer/system/gui.md:62
#: 75826aa1fd704fb084142e79b142961f
msgid "To sum up, this solution has the following benefits:"
msgstr ""

#: ../developer/system/gui.md:64
#: daa1dd3176e04f13832a643283f08ac0
msgid "window updates at DRAM speed"
msgstr ""

#: ../developer/system/gui.md:65
#: c6279e7fe1f9486dad6dcbdb7a0fe693
msgid "no changes to Xorg code"
msgstr ""

#: ../developer/system/gui.md:66
#: 371058928df348bba273518fa3969344
msgid "minimal size of the supporting code"
msgstr ""

#: ../developer/system/gui.md:68
#: 7f5b0123c51e4038b7a2b663d344890b
msgid "![gui.png](/attachment/doc/gui.png)"
msgstr ""

#: ../developer/system/gui.md:68
#: 6cc44ed37b944ae9a8622441699e4424
msgid "gui.png"
msgstr ""

#: ../developer/system/gui.md:70
#: 02f2e849a9db4ddc92106383a3270b42
msgid "Security markers on dom0 windows"
msgstr ""

#: ../developer/system/gui.md:73
#: d66c0ad197884ca1a48523417dc7df8e
msgid "It is important that the user knows which AppVM a given window belongs to. This prevents a rogue AppVM from painting a window pretending to belong to other AppVM or dom0 and trying to steal, for example, passwords."
msgstr ""

#: ../developer/system/gui.md:75
#: b89aab27f2e34b4785d4c2da2f71efe8
msgid "In Qubes, a custom window decorator is used that paints a colourful frame (the colour is determined during AppVM creation) around decorated windows. Additionally, the window title always starts with **[name of the AppVM]**. If a window has an *override_redirect* attribute, meaning that it should not be treated by a window manager (typical case is menu windows), *qubes_guid* draws a two-pixel colourful frame around it manually."
msgstr ""

#: ../developer/system/gui.md:77
#: e7689f5cd471465b9976008b1baa4f71
msgid "Clipboard sharing implementation"
msgstr ""

#: ../developer/system/gui.md:80
#: e3f1bea9b0404e258d2e973e85ae2628
msgid "Certainly, it would be insecure to allow AppVM to read/write the clipboards of other AppVMs unconditionally. Therefore, the following mechanism is used:"
msgstr ""

#: ../developer/system/gui.md:83
#: 5baa75bd553743e79d410eb24c7e254f
msgid "there is a \"qubes clipboard\" in dom0 - its contents are stored in a regular file in dom0."
msgstr ""

#: ../developer/system/gui.md:84
#: 6904261d5d1046b8972838a8fbf6a5ad
msgid "if the user wants to copy local AppVM clipboard to qubes clipboard, she must focus on any window belonging to this AppVM, and press **Ctrl-Shift-C**. This combination is trapped by *qubes-guid*, and `CLIPBOARD_REQ` message is sent to AppVM. *qubes-gui* responds with *CLIPBOARD_DATA* message followed by clipboard contents."
msgstr ""

#: ../developer/system/gui.md:85
#: 6d9847ecdd9a445386478de58a19984c
msgid "the user focuses on other AppVM window, presses **Ctrl-Shift-V**. This combination is trapped by *qubes-guid*, and `CLIPBOARD_DATA` message followed by qubes clipboard contents is sent to AppVM; *qubes_gui* copies data to the local clipboard, and then user can paste its contents to local applications normally."
msgstr ""

#: ../developer/system/gui.md:87
#: 1d61abe5ec174ae18a96763309d03b83
msgid "This way, the user can quickly copy clipboards between AppVMs. This action is fully controlled by the user, it cannot be triggered/forced by any AppVM."
msgstr ""

#: ../developer/system/gui.md:90
#: 1f603efdc7e74c17a69453e6ea1cd4d9
msgid "*qubes_gui* and *qubes_guid* code notes"
msgstr ""

#: ../developer/system/gui.md:93
#: 574e3dafe7b84467821ead19a7dec457
msgid "Both applications are structured similarly. They use *select* function to wait for any of these two event sources:"
msgstr ""

#: ../developer/system/gui.md:95
#: b7e830cbc7d74ecea74cdef1462181a9
msgid "messages from the local X server"
msgstr ""

#: ../developer/system/gui.md:96
#: 1d1ab24c65ee4ef8b75de61179952211
msgid "messages from the vchan connecting to the remote party"
msgstr ""

#: ../developer/system/gui.md:98
#: a31041fd75fd4c11a7c43b0a52324a12
msgid "The XEvents are handled by the *handle_xevent_eventname* function, and messages are handled by *handle_messagename* function. One should be very careful when altering the actual *select* loop, because both XEvents and vchan messages are buffered, and  *select* will not wake for each message."
msgstr ""

#: ../developer/system/gui.md:100
#: d49822778fd5483fa8849125c2538128
msgid "If one changes the number/order/signature of messages, one should increase the *QUBES_GUID_PROTOCOL_VERSION* constant in *messages.h* include file."
msgstr ""

#: ../developer/system/gui.md:102
#: edbb6d6df2db4532a24d65de5800a013
msgid "*qubes_guid* writes debugging information to */var/log/qubes/qubes.domain_id.log* file; *qubes_gui* writes debugging information to */var/log/qubes/gui_agent.log*. Include these files when reporting a bug."
msgstr ""

#: ../developer/system/gui.md:105
#: cd7db85049c1437ba2d214ab79559356
msgid "AppVM -> dom0 messages"
msgstr ""

#: ../developer/system/gui.md:108
#: 5afef9f7682b4ee5a8cacd1b6431c863
msgid "Proper handling of the below messages is security-critical. Observe that beside two messages (`CLIPBOARD` and `MFNDUMP`) the rest have fixed size, so the parsing code can be small."
msgstr ""

#: ../developer/system/gui.md:111
#: c5a8c606ca79481eb03a69b232140a8b
msgid "The *override_redirect* window attribute is explained at [Override Redirect Flag](https://tronche.com/gui/x/xlib/window/attributes/override-redirect.html). The *transient_for* attribute is explained at [Transient_for attribute](https://tronche.com/gui/x/icccm/sec-4.html#WM_TRANSIENT_FOR)."
msgstr ""

#: ../developer/system/gui.md:113
#: 84a6f4b99552495895ea8f007d14f057
msgid "Window manager hints and flags are described in the [Extended Window Manager Hints (EWMH) spec](https://standards.freedesktop.org/wm-spec/latest/), especially under the `_NET_WM_STATE` section."
msgstr ""

#: ../developer/system/gui.md:115
#: dd41b3ed252d475a9703c6f3eaf9a23e
msgid "Each message starts with the following header:"
msgstr ""

#: ../developer/system/gui.md:130
#: 4fd26cc5bddf4c0cbc317656829e84b5
msgid "This header is followed by message-specific data:"
msgstr ""

#: ../developer/system/gui.md:207
#: 1047d97d92994331966d5bbe71c6c813
msgid "The \"num_mfn\" 32bit integers follow the shm_cmd structure; \"off\" is the offset of the composite buffer start in the first frame; \"shmid\" and \"domid\" parameters are just placeholders (to be filled by *qubes_guid*), so that we can use the same structure when talking to *shmoverride.so*|"
msgstr ""

#: ../developer/system/gui.md:274
#: 05358d64ea1746318c8c8d23527f353f
msgid "Dom0 -> AppVM messages"
msgstr ""

#: ../developer/system/gui.md:277
#: a52dff0ec235498b9b8b800b1a8387a1
msgid "Proper handling of the below messages is NOT security-critical."
msgstr ""

#: ../developer/system/gui.md:279
#: 6451b60b2b324a0486e02330c9f4a1ed
msgid "Each message starts with the following header"
msgstr ""

#: ../developer/system/gui.md:288
#: dd99f0c4b6ee40ee865e7ea5f3f9a9e0
msgid "The header is followed by message-specific data:"
msgstr ""

#: ../developer/system/gui.md:420
#: 0448a78978214f7fbeae07bdc53784c4
msgid "`KEYPRESS`, `BUTTON`, `MOTION`, `FOCUS` messages pass information extracted from dom0 XEvent; see appropriate event documentation."
msgstr ""
